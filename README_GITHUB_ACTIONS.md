# GitHub Actions 自动化部署指南

本项目已配置为在GitHub Actions中每天北京时间晚上7:30自动运行天气爬虫脚本。

**更新说明**：所有GitHub Actions已升级到最新版本（v4），以解决弃用警告。

## 功能特性

- ✅ 定时运行：每天北京时间19:30（UTC 11:30）自动执行
- ✅ 自动重试：网络请求失败时自动重试3次
- ✅ 时区支持：正确处理北京时间判断
- ✅ 日志记录：详细的执行日志，便于问题排查
- ✅ 结果保存：自动上传生成的图片文件
- ✅ 错误处理：完善的异常处理机制

## 文件结构

```
.github/workflows/
├── daily-weather-spider.yml      # 主工作流配置
weather_spider/
├── config.py                     # 配置管理模块（新增）
├── daily_summary.py              # 已更新，支持时区和配置
└── network_enhanced.py           # 增强的网络请求模块（新增）
```

## 配置说明

### 环境变量

工作流使用以下环境变量：

- `TZ`: 设置为 `Asia/Shanghai`，确保使用北京时间
- `REQUEST_TIMEOUT`: 请求超时时间（秒）
- `MAX_RETRIES`: 最大重试次数
- `RETRY_DELAY`: 重试间隔（秒）

### 目录说明

- `downloads/`: 下载的原始图片存储
  - `downloads/pcp/`: 降水数据
  - `downloads/tmp/`: 温度数据
- `output/`: 生成的对比图片输出
- `weather/`: 备用目录（某些代码可能需要）

## 使用方法

### 1. 自动执行
工作流会在每天北京时间19:30自动运行，无需手动干预。

### 2. 手动触发
可以在GitHub仓库的Actions页面手动触发工作流运行。

### 3. 查看结果
- 执行日志：在Actions页面查看详细日志
- 生成的文件：在Artifacts中下载生成的图片文件
- 发布版本：可选择创建包含日期标签的发布

## 优化点

### 1. 时区处理
- 原代码使用本地时间，可能在不同环境下产生问题
- 新增配置模块统一管理时区设置
- 在GitHub Actions中明确设置Asia/Shanghai时区

### 2. 网络稳定性
- 添加重试机制，提高下载成功率
- 设置合理的超时时间
- 详细的错误日志记录

### 3. 资源管理
- 使用pip缓存加速依赖安装
- 仅在有输出文件时上传Artifacts
- 自动清理30天前的Artifacts

### 4. 监控和通知
- 生成执行摘要，方便快速了解运行状态
- 显示日志文件的关键信息
- 可选的自动发布功能

## 故障排查

### 1. 下载失败
- 检查网络连接
- 查看debug.log中的错误信息
- 确认目标网站是否可访问

### 2. 时间判断错误
- 确认时区设置正确
- 检查是否在19:30前后运行
- 查看日志中的时间信息

### 3. 文件生成失败
- 检查downloads目录是否有图片
- 确认PIL库正常工作
- 查看图片处理相关日志

## 注意事项

1. 确保GitHub仓库已启用Actions
2. 检查`requirements.txt`中的依赖是否完整
3. 定期查看运行日志，确保脚本正常执行
4. 如需修改运行时间，编辑cron表达式

## 自定义配置

如需修改配置，可以：

1. 编辑`.github/workflows/daily-weather-spider.yml`中的环境变量
2. 修改`weather_spider/config.py`中的默认配置
3. 调整`weather_spider/network_enhanced.py`中的重试参数