# GitHub Actions Artifact 覆盖问题解答

## ❓ 用户的担心

**问题**：每天都使用固定名称 "weather-downloads"，数据不会覆盖吗？

## ✅ 回答：不会覆盖！

GitHub Actions 的 artifact 系统采用**版本控制**机制：

### 版本控制行为

```
第1天 (2024-12-20):
  - 上传 "weather-downloads" → 创建版本 #1
  - 包含: downloads/pcp/20241219/, downloads/tmp/20241219/

第2天 (2024-12-21):
  - 上传 "weather-downloads" → 创建版本 #2 (不会覆盖 #1)
  - 包含: downloads/pcp/20241219/, 20241220/, downloads/tmp/20241219/, 20241220/

第3天 (2024-12-22):
  - 上传 "weather-downloads" → 创建版本 #3 (不会覆盖 #1 和 #2)
  - 包含: downloads/pcp/20241219/, 20241220/, 20241221/, downloads/tmp/20241219/, 20241220/, 20241221/

...
```

### 保留策略

```yaml
retention-days: 90  # 保留90天
```

- 保留最近 90 天的所有版本
- 超过 90 天的版本会被自动删除
- 每个版本都包含累积的数据

### 数据恢复机制

工作流尝试从最近 5 次运行中恢复：

```bash
run_list=$(gh run list --workflow=daily-weather-spider.yml --limit 5)
# 获取最近的5次运行ID

for run_id in $run_list; do
  gh run download "$run_id" --name "weather-downloads"
  # 找到第一个可用的版本就停止
done
```

**优势**：
- 如果某次运行失败，会尝试更早的运行
- 确保能找到可用的历史数据
- 逐步累积数据

## 📊 数据累积示例

### 第1天运行后
```
downloads/
├── pcp/20241219/  (18个文件)
└── tmp/20241219/  (18个文件)
```

### 第2天运行后
```
downloads/
├── pcp/
│   ├── 20241219/  (18个文件) ← 从历史恢复
│   └── 20241220/  (18个文件) ← 新下载
└── tmp/
    ├── 20241219/  (18个文件) ← 从历史恢复
    └── 20241220/  (18个文件) ← 新下载
```

### 第5天运行后
```
downloads/
├── pcp/
│   ├── 20241219/  (18个文件)
│   ├── 20241220/  (18个文件)
│   ├── 20241221/  (18个文件)
│   └── 20241222/  (18个文件)
└── tmp/
    ├── 20241219/  (18个文件)
    ├── 20241220/  (18个文件)
    ├── 20241221/  (18个文件)
    └── 20241222/  (18个文件)
```

## 🔄 完整工作流程

```
┌─────────────────────────────────────────────────────────┐
│ GitHub Actions 每天运行 (北京时间 19:30)                   │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 1. 恢复历史数据                                           │
│    - 尝试从最近5次运行下载 "weather-downloads"            │
│    - 合并到 downloads/ 目录                               │
│    - 输出: "已有降水数据天数: X"                          │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 2. 下载新数据                                             │
│    - 下载当天的天气数据                                   │
│    - 保存到 downloads/[vrbl]/[date]/                     │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 3. 生成对比图片                                           │
│    - 使用历史数据和当天数据                               │
│    - 创建对比图                                           │
└────────────────────┬────────────────────────────────────┘
                     │
                     ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 上传 artifact                                          │
│    - 名称: weather-downloads (固定)                       │
│    - 创建新版本，不覆盖历史版本                           │
│    - 保留期: 90天                                        │
└─────────────────────────────────────────────────────────┘
```

## 💡 验证方法

### 查看所有 artifact 版本

在 GitHub 仓库页面：
1. 进入 "Actions" 标签页
2. 点击任意工作流运行
3. 在 "Artifacts" 部分可以看到：
   - `weather-downloads` (版本 #1) - 2024-12-20
   - `weather-downloads` (版本 #2) - 2024-12-21
   - `weather-downloads` (版本 #3) - 2024-12-22
   - ...

### 命令行查看

```bash
# 列出所有 artifact
gh api repos/{owner}/{repo}/actions/artifacts --jq '.artifacts[] | "\(.name) v\(.version) - \(.created_at)"'

# 输出示例:
# weather-downloads v1 - 2024-12-20T11:30:00Z
# weather-downloads v2 - 2024-12-21T11:30:00Z
# weather-downloads v3 - 2024-12-22T11:30:00Z
```

## 🎯 结论

**不会覆盖！** GitHub Actions 的 artifact 系统使用版本控制，相同名称会创建新版本而不是覆盖旧版本。

这种机制非常适合我们的需求：
- ✅ 数据累积：每天的数据都会保留
- ✅ 节省空间：只保留 90 天，超期自动删除
- ✅ 可靠性：如果某次运行失败，可以从之前的版本恢复
- ✅ 简单管理：固定名称，无需管理多个名称

## 📝 最佳实践

1. **使用固定名称**：方便管理，不需要跟踪多个名称
2. **合理设置保留期**：90 天足够累积数据，也不会占用过多空间
3. **监控数据量**：定期检查 downloads 目录大小
4. **失败重试机制**：工作流会自动尝试从更早的版本恢复

因此，我们的解决方案是正确的，不需要修改！
