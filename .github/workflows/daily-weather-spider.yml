name: Daily Weather Spider

on:
  schedule:
    # 每天北京时间晚上7:30运行 (UTC时间 11:30)
    - cron: '30 11 * * *'
  workflow_dispatch: # 允许手动触发

env:
  PYTHONUNBUFFERED: '1'
  TZ: 'Asia/Shanghai'  # 设置时区为北京时间
  # 禁用GitHub Actions调试输出，避免特殊字符被误解为命令
  ACTIONS_STEP_DEBUG: false
  ACTIONS_RUNNER_DEBUG: false
  # 禁用GitHub Actions命令处理，避免路径被误解为命令
  ACTIONS_ALLOW_UNSECURE_COMMANDS: 'true'

jobs:
  run-weather-spider:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set timezone
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        date

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Restore weather data downloads
      uses: actions/download-artifact@v4
      with:
        name: weather-downloads-latest
        path: downloads
      continue-on-error: true

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install retrying  # 添加重试库

    - name: Create necessary directories
      run: |
        mkdir -p downloads/pcp
        mkdir -p downloads/tmp
        mkdir -p output
        mkdir -p weather  # 创建weather目录以防代码需要

    - name: Clean up old files
      run: |
        # 设置保留天数（可通过环境变量自定义）
        RETENTION_DAYS=${RETENTION_DAYS:-7}

        # 使用清理脚本
        chmod +x .github/cleanup-config.sh
        .github/cleanup-config.sh

        # 清理后的空间使用情况已保存到文件，避免在GitHub Actions输出中显示
        du -sh downloads output > disk_usage.log 2>/dev/null || true

    - name: Set environment variables for network
      run: |
        echo "REQUEST_TIMEOUT=30" >> $GITHUB_ENV
        echo "MAX_RETRIES=3" >> $GITHUB_ENV
        echo "RETRY_DELAY=5" >> $GITHUB_ENV

    - name: Run weather spider
      run: |
        # 设置环境变量
        export WEATHER_SPIDER_MODE="github_actions"
        export WEATHER_SPIDER_TIMEZONE="Asia/Shanghai"

        # 禁用Shell回显，避免显示命令执行过程
        set +x

        # 运行脚本：将所有输出重定向到文件，避免GitHub Actions解析错误
        python -u run_weather_spider.py > execution.log 2>&1

      continue-on-error: false

    - name: Check if outputs exist
      id: check-outputs
      run: |
        # 初始化输出变量
        echo "has_outputs=false" >> $GITHUB_OUTPUT

        # 检查output目录是否存在且有内容
        if [ -d "output" ] && [ "$(ls -A output 2>/dev/null)" ]; then
          # 排除.gitkeep文件
          file_count=$(find output -type f ! -name '.gitkeep' 2>/dev/null | wc -l)
          if [ "$file_count" -gt 0 ]; then
            echo "has_outputs=true" >> $GITHUB_OUTPUT
            # 文件计数信息保存到日志，避免在GitHub Actions输出中显示
            echo "Found $file_count output files" > file_count.log
          fi
        fi

    - name: Create summary
      if: always()
      run: |
        echo "## Weather Spider Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-outputs.outputs.has_outputs }}" == "true" ]; then
          echo "- Output files generated: Yes" >> $GITHUB_STEP_SUMMARY
          echo "- Files have been uploaded as artifacts" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Output files generated: No" >> $GITHUB_STEP_SUMMARY
        fi

        # 日志文件将通过artifact上传，不在summary中显示以避免解析错误

    - name: Upload output artifacts
      uses: actions/upload-artifact@v4
      if: steps.check-outputs.outputs.has_outputs == 'true'
      with:
        name: weather-outputs-${{ github.run_number }}
        path: |
          output/
          debug.log
          execution.log
          disk_usage.log
          file_count.log
        retention-days: 30

    - name: Upload weather downloads
      uses: actions/upload-artifact@v4
      with:
        name: weather-downloads-latest
        path: downloads/
        retention-days: 7

    # 注意：Create release 步骤已移除，因为它需要额外的权限
    # 所有输出文件已通过 artifacts 上传，无需额外创建 release