name: Daily Weather Spider

on:
  schedule:
    # 每天北京时间晚上7:30运行 (UTC时间 11:30)
    - cron: '30 11 * * *'
  workflow_dispatch: # 允许手动触发

env:
  PYTHONUNBUFFERED: '1'
  TZ: 'Asia/Shanghai'  # 设置时区为北京时间

jobs:
  run-weather-spider:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set timezone
      run: |
        sudo timedatectl set-timezone Asia/Shanghai
        date

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install retrying  # 添加重试库

    - name: Create necessary directories
      run: |
        mkdir -p downloads/pcp
        mkdir -p downloads/tmp
        mkdir -p output
        mkdir -p weather  # 创建weather目录以防代码需要

    - name: Clean up old files
      run: |
        # 设置保留天数（可通过环境变量自定义）
        RETENTION_DAYS=${RETENTION_DAYS:-7}
        echo "清理 $RETENTION_DAYS 天前的文件"

        # 使用清理脚本
        chmod +x .github/cleanup-config.sh
        .github/cleanup-config.sh

        # 显示清理后的空间使用情况
        echo "清理后的磁盘使用情况："
        du -sh downloads output 2>/dev/null || true

    - name: Set environment variables for network
      run: |
        echo "REQUEST_TIMEOUT=30" >> $GITHUB_ENV
        echo "MAX_RETRIES=3" >> $GITHUB_ENV
        echo "RETRY_DELAY=5" >> $GITHUB_ENV

    - name: Run weather spider
      run: |
        # 设置环境变量
        export WEATHER_SPIDER_MODE="github_actions"
        export WEATHER_SPIDER_TIMEZONE="Asia/Shanghai"

        echo "开始运行天气爬虫..."
        echo "当前目录: $(pwd)"
        echo "目录内容:"
        ls -la

        # 运行脚本
        python -u run_weather_spider.py 2>&1 | tee execution.log

        echo "脚本执行完成"
        echo "生成文件列表:"
        find output -type f ! -name '.gitkeep' 2>/dev/null || echo "未找到输出文件"
      continue-on-error: false

    - name: Check if outputs exist
      id: check-outputs
      run: |
        # 初始化输出变量
        echo "has_outputs=false" >> $GITHUB_OUTPUT

        # 检查output目录是否存在且有内容
        if [ -d "output" ] && [ "$(ls -A output 2>/dev/null)" ]; then
          # 排除.gitkeep文件
          file_count=$(find output -type f ! -name '.gitkeep' 2>/dev/null | wc -l)
          if [ "$file_count" -gt 0 ]; then
            echo "has_outputs=true" >> $GITHUB_OUTPUT
            echo "Found $file_count output files"
          fi
        fi

    - name: Create summary
      if: always()
      run: |
        echo "## Weather Spider Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Date: $(date '+%Y-%m-%d %H:%M:%S %Z')" >> $GITHUB_STEP_SUMMARY
        echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check-outputs.outputs.has_outputs }}" == "true" ]; then
          echo "- Output files generated: Yes" >> $GITHUB_STEP_SUMMARY
          echo "- Output directory contents:" >> $GITHUB_STEP_SUMMARY
          ls -la output/ >> $GITHUB_STEP_SUMMARY
        else
          echo "- Output files generated: No" >> $GITHUB_STEP_SUMMARY
        fi

        # 显示日志文件的最后50行
        if [ -f "debug.log" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Last 50 lines of debug log:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tail -n 50 debug.log >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Upload output artifacts
      uses: actions/upload-artifact@v4
      if: steps.check-outputs.outputs.has_outputs == 'true'
      with:
        name: weather-outputs-${{ github.run_number }}
        path: |
          output/
          debug.log
        retention-days: 30

    - name: Create release (optional)
      if: success() && steps.check-outputs.outputs.has_outputs == 'true'
      run: |
        # 创建包含日期的标签（可选）
        TAG_NAME="weather-data-$(date +'%Y%m%d')"

        # 检查标签是否已存在
        if ! git rev-parse --verify "refs/tags/$TAG_NAME" >/dev/null 2>&1; then
          # 创建发布
          gh release create "$TAG_NAME" \
            --title "Weather Data $(date +'%Y-%m-%d')" \
            --notes "Automated weather data update for $(date +'%Y-%m-%d %H:%M:%S')" \
            --prerelease \
            output/*
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}